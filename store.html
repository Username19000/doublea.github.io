<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Double A SMP - Store</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Tebex.js for embedded checkout -->
  <script src="https://js.tebex.io/v/1.js" defer></script>

  <!-- Store Configuration -->
  <script src="store-config.js"></script>

  <!-- External CSS -->
  <link rel="stylesheet" href="store.css">

  <!-- Custom store-specific styles -->
  <style>
    /* Force ranks grid to 3 columns */
    #ranks-grid.products-grid {
      grid-template-columns: repeat(3, 1fr) !important;
    }

    /* Make rank card images fit properly */
    .product-card .product-image {
      width: 100%;
      height: 250px;
      object-fit: scale-down;
      border-radius: 8px;
    }

    @media (max-width: 1024px) {
      #ranks-grid.products-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media (max-width: 640px) {
      #ranks-grid.products-grid {
        grid-template-columns: 1fr !important;
      }
    }
  </style>

  <!-- Tebex Modal Overrides for Mobile -->
  <style>
    /* Ensure Tebex checkout modal works on mobile and has proper z-index */
    .tebex-checkout-wrapper,
    .tebex-checkout-modal,
    [class*="tebex-checkout"],
    iframe[src*="checkout.tebex.io"] {
      position: fixed !important;
      z-index: 9999 !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      max-width: 100% !important;
      max-height: 100% !important;
      border: none !important;
    }

    /* Tebex overlay */
    .tebex-checkout-overlay,
    [class*="tebex"][class*="overlay"] {
      position: fixed !important;
      z-index: 9998 !important;
      background: rgba(0, 0, 0, 0.8) !important;
    }

    /* Make sure Tebex content is scrollable on mobile */
    @media (max-width: 768px) {
      .tebex-checkout-modal,
      .tebex-checkout-wrapper {
        overflow-y: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
    }
  </style>

  <!-- 
    Custom Dialog Styles
    NOTE: These styles are inline because they define the custom modal dialogs
    that replace Chrome's default alert/prompt/confirm. They need to be loaded
    immediately with the page and have high z-index (10000) to overlay everything
    including the Tebex checkout modal. If you want to move these to store.css,
    make sure they're at the end of the file with !important on z-index.
  -->
  <style>
    /* Custom Alert/Prompt Modals */
    .custom-dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .custom-dialog-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .custom-dialog {
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 2rem;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      transform: scale(0.9) translateY(20px);
      transition: transform 0.3s ease;
    }

    .custom-dialog-overlay.active .custom-dialog {
      transform: scale(1) translateY(0);
    }

    .custom-dialog-icon {
      font-size: 3rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .custom-dialog-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      text-align: center;
      margin-bottom: 0.5rem;
    }

    .custom-dialog-message {
      color: var(--text-muted);
      text-align: center;
      line-height: 1.6;
      margin-bottom: 1.5rem;
    }

    .custom-dialog-input {
      width: 100%;
      padding: 0.875rem;
      background: var(--dark);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      font-family: var(--font-display);
      margin-bottom: 1.5rem;
      transition: border-color 0.3s ease;
    }

    .custom-dialog-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .custom-dialog-buttons {
      display: flex;
      gap: 0.75rem;
    }

    .custom-dialog-btn {
      flex: 1;
      padding: 0.875rem;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .custom-dialog-btn.primary {
      background: var(--primary);
      color: white;
    }

    .custom-dialog-btn.primary:hover {
      background: #019a9d;
      transform: translateY(-2px);
    }

    .custom-dialog-btn.secondary {
      background: transparent;
      border: 2px solid var(--border);
      color: var(--text);
    }

    .custom-dialog-btn.secondary:hover {
      border-color: var(--text);
    }

    .custom-dialog-btn.warning {
      background: #ef4444;
      color: white;
    }

    .custom-dialog-btn.warning:hover {
      background: #dc2626;
    }
  </style>
</head>

<body>
  <div id="header-placeholder"></div>

  <!-- Hero -->
  <section class="store-hero">
    <div class="store-hero-content">
      <div class="store-icon">üõí</div>
      <h1>Server Store</h1>
      <p>Unlock exclusive ranks and perks to enhance your Double A SMP experience</p>

      <!-- Username Display/Sign-in -->
      <div id="username-display" style="margin-top: 2rem;">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </section>

  <!-- Category Navigation -->
  <nav class="category-nav">
    <ul class="category-list">
      <li><a href="#ranks" class="category-item active" onclick="scrollToSection('ranks', event)">üéñÔ∏è Ranks</a></li>
      <li><a href="#crates" class="category-item" onclick="scrollToSection('crates', event)">üì¶ Crates</a></li>
      <li><a href="#cosmetics" class="category-item" onclick="scrollToSection('cosmetics', event)">‚ú® Cosmetics</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="container page-content">
    <!-- Ranks Section -->
    <section id="ranks" class="products-section">
      <h2 class="section-title">Server Ranks</h2>
      <p class="section-subtitle">Explore our various membership tiers, each packed with special perks and privileges
        designed to make your gaming experience even more enjoyable.<br>Just looking to explore what each rank has to
        offer? Pay by the month for a more affordable option!<br>Click any rank for full details.</p>

      <div class="products-grid" id="ranks-grid">
        <!-- Populated by JavaScript -->
      </div>
    </section>

    <!-- Crates Section -->
    <section id="crates" class="products-section">
      <h2 class="section-title">Mystery Crates</h2>
      <p class="section-subtitle">Random rewards and rare items</p>

      <div class="products-grid" id="crates-grid">
        <!-- Populated by JavaScript -->
      </div>
    </section>

    <!-- Cosmetics Section -->
    <section id="cosmetics" class="products-section">
      <h2 class="section-title">Cosmetics & Utilities</h2>
      <p class="section-subtitle">Visual effects and convenience items</p>

      <div class="products-grid" id="cosmetics-grid">
        <!-- Populated by JavaScript -->
      </div>
    </section>
  </main>

  <!-- Modal for package details -->
  <div class="modal-overlay" id="modal">
    <div class="modal-content">
      <div id="modal-header" class="modal-header">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-icon" id="modal-icon"></div>
        <h2 class="modal-title" id="modal-title"></h2>
        <div class="modal-price" id="modal-price"></div>
        <div class="modal-price-subtitle" id="modal-price-subtitle"></div>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div id="modal-footer" class="modal-footer"></div>
    </div>
  </div>

  <!-- Custom Alert Dialog -->
  <div class="custom-dialog-overlay" id="custom-alert">
    <div class="custom-dialog">
      <div class="custom-dialog-icon" id="alert-icon">‚ö†Ô∏è</div>
      <div class="custom-dialog-title" id="alert-title">Alert</div>
      <div class="custom-dialog-message" id="alert-message"></div>
      <div class="custom-dialog-buttons">
        <button class="custom-dialog-btn primary" id="alert-ok-btn" onclick="closeCustomAlert()">OK</button>
      </div>
    </div>
  </div>

  <!-- Custom Prompt Dialog -->
  <div class="custom-dialog-overlay" id="custom-prompt">
    <div class="custom-dialog">
      <div class="custom-dialog-icon" id="prompt-icon">üéÅ</div>
      <div class="custom-dialog-title" id="prompt-title">Enter Information</div>
      <div class="custom-dialog-message" id="prompt-message"></div>
      <input type="text" class="custom-dialog-input" id="prompt-input" placeholder="">
      <div class="custom-dialog-buttons">
        <button class="custom-dialog-btn secondary" onclick="closeCustomPrompt(false)">Cancel</button>
        <button class="custom-dialog-btn primary" onclick="closeCustomPrompt(true)">OK</button>
      </div>
    </div>
  </div>

  <!-- Custom Confirm Dialog -->
  <div class="custom-dialog-overlay" id="custom-confirm">
    <div class="custom-dialog">
      <div class="custom-dialog-icon" id="confirm-icon">‚ùì</div>
      <div class="custom-dialog-title" id="confirm-title">Confirm</div>
      <div class="custom-dialog-message" id="confirm-message"></div>
      <div class="custom-dialog-buttons">
        <button class="custom-dialog-btn secondary" onclick="closeCustomConfirm(false)">Cancel</button>
        <button class="custom-dialog-btn primary" onclick="closeCustomConfirm(true)">OK</button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="AA_Logo.png" alt="Logo" style="height: 32px;">
          <span>Double A SMP</span>
        </div>
        <p class="footer-text">Support the server and unlock exclusive perks</p>
      </div>
    </div>
  </footer>

  <script>
    // ========================================
    // CUSTOM DIALOG FUNCTIONS
    // ========================================

    let alertResolve = null;
    let promptResolve = null;
    let confirmResolve = null;

    // Custom Alert
    function customAlert(message, title = 'Alert', icon = '‚ö†Ô∏è') {
      return new Promise((resolve) => {
        alertResolve = resolve;
        document.getElementById('alert-icon').textContent = icon;
        document.getElementById('alert-title').textContent = title;
        document.getElementById('alert-message').textContent = message;
        document.getElementById('custom-alert').classList.add('active');
      });
    }

    function closeCustomAlert() {
      document.getElementById('custom-alert').classList.remove('active');
      if (alertResolve) {
        alertResolve();
        alertResolve = null;
      }
    }

    // Custom Prompt
    function customPrompt(message, title = 'Enter Information', placeholder = '', icon = 'üéÅ') {
      return new Promise((resolve) => {
        promptResolve = resolve;
        document.getElementById('prompt-icon').textContent = icon;
        document.getElementById('prompt-title').textContent = title;
        document.getElementById('prompt-message').textContent = message;
        const input = document.getElementById('prompt-input');
        input.placeholder = placeholder;
        input.value = '';
        document.getElementById('custom-prompt').classList.add('active');
        setTimeout(() => input.focus(), 100);
      });
    }

    function closeCustomPrompt(confirmed) {
      const value = confirmed ? document.getElementById('prompt-input').value : null;
      document.getElementById('custom-prompt').classList.remove('active');
      if (promptResolve) {
        promptResolve(value);
        promptResolve = null;
      }
    }

    // Custom Confirm
    function customConfirm(message, title = 'Confirm', icon = '‚ùì') {
      return new Promise((resolve) => {
        confirmResolve = resolve;
        document.getElementById('confirm-icon').textContent = icon;
        document.getElementById('confirm-title').textContent = title;
        document.getElementById('confirm-message').textContent = message;
        document.getElementById('custom-confirm').classList.add('active');
      });
    }

    function closeCustomConfirm(confirmed) {
      document.getElementById('custom-confirm').classList.remove('active');
      if (confirmResolve) {
        confirmResolve(confirmed);
        confirmResolve = null;
      }
    }

    // Handle Enter key in prompt
    document.getElementById('prompt-input').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        closeCustomPrompt(true);
      }
    });

    // Close on overlay click
    document.querySelectorAll('.custom-dialog-overlay').forEach(overlay => {
      overlay.addEventListener('click', function (e) {
        if (e.target === this) {
          if (this.id === 'custom-alert') closeCustomAlert();
          if (this.id === 'custom-prompt') closeCustomPrompt(false);
          if (this.id === 'custom-confirm') closeCustomConfirm(false);
        }
      });
    });

    // ========================================
    // USERNAME MANAGEMENT
    // ========================================

    let currentUsername = localStorage.getItem('minecraft_username') || '';

    function renderUsernameDisplay() {
      const display = document.getElementById('username-display');

      if (currentUsername) {
        display.innerHTML = `
          <div style="background: rgba(1, 161, 164, 0.1); border: 1px solid var(--primary); border-radius: 12px; padding: 1rem; display: inline-block;">
            <span style="color: var(--text); font-weight: 600;">Signed in as: <strong style="color: var(--primary);">${currentUsername}</strong></span>
            <button onclick="signOut()" style="margin-left: 1rem; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--primary); color: var(--primary); border-radius: 6px; cursor: pointer; font-weight: 600;">
              Sign Out
            </button>
          </div>
        `;
      } else {
        display.innerHTML = `
          <div style="background: rgba(242, 184, 65, 0.1); border: 1px solid var(--secondary); border-radius: 12px; padding: 1rem; display: inline-block;">
            <span style="color: var(--text); margin-right: 1rem;">Enter your Minecraft username to get started:</span>
            <input type="text" id="username-signin-input" placeholder="Minecraft Username" style="padding: 0.5rem 1rem; background: var(--dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text); margin-right: 0.5rem;" />
            <button onclick="signIn()" style="padding: 0.5rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
              Sign In
            </button>
          </div>
        `;
      }
    }

    async function signIn() {
      const input = document.getElementById('username-signin-input');
      const username = input.value.trim();

      if (!username) {
        await customAlert('Please enter your Minecraft username', 'Username Required', '‚ö†Ô∏è');
        return;
      }

      currentUsername = username;
      localStorage.setItem('minecraft_username', username);
      renderUsernameDisplay();
    }

    async function signOut() {
      const confirmed = await customConfirm(
        'Sign out? You\'ll need to be signed in for purchases.',
        'Sign Out',
        'üëã'
      );

      if (confirmed) {
        currentUsername = '';
        localStorage.removeItem('minecraft_username');
        renderUsernameDisplay();
      }
    }

    // ========================================
    // HEADLESS API (PURCHASE ONLY)
    // ========================================

    async function createBasket(username) {
      const response = await fetch(
        `https://headless.tebex.io/api/accounts/${STORE_CONFIG.tebexPublicToken}/baskets`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({
            complete_url: window.location.href,
            cancel_url: window.location.href,
            complete_auto_redirect: false,
            username: username
          })
        }
      );

      if (!response.ok) {
        const error = await response.text();
        throw new Error(`Failed to create basket: ${error}`);
      }

      const data = await response.json();
      return data.data;
    }

    async function addPackageToBasket(basketIdent, packageId) {
      // First get basket to check for username_id
      const basketResponse = await fetch(
        `https://headless.tebex.io/api/accounts/${STORE_CONFIG.tebexPublicToken}/baskets/${basketIdent}`,
        { headers: { 'Accept': 'application/json' } }
      );
      const basketData = await basketResponse.json();
      const basket = basketData.data;

      const requestBody = {
        package_id: parseInt(packageId),
        quantity: 1
      };

      if (basket.username_id) {
        requestBody.variable_data = {
          username_id: basket.username_id
        };
      }

      const response = await fetch(
        `https://headless.tebex.io/api/baskets/${basketIdent}/packages`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(requestBody)
        }
      );

      if (!response.ok) {
        let errorMessage = `HTTP ${response.status}`;
        try {
          const errorData = await response.json();

          // Extract error from Tebex response
          if (errorData.detail) {
            errorMessage = errorData.detail;
          } else if (errorData.error_message) {
            errorMessage = errorData.error_message;
          } else if (errorData.message) {
            errorMessage = errorData.message;
          } else if (errorData.title) {
            errorMessage = errorData.title;
          }
        } catch (e) {
          errorMessage = `${response.status}: ${response.statusText}`;
        }
        throw new Error(errorMessage);
      }

      return await response.json();
    }

    async function purchasePackage(packageId, packageName, price, isSubscription, forUsername = null) {
      try {
        // Determine username
        let username = forUsername;

        // If no username passed, current user must be signed in
        if (!username && !currentUsername) {
          await customAlert('Please sign in with your Minecraft username first!', 'Sign In Required', '‚ö†Ô∏è');
          return;
        }

        // Use current user's username if not a gift
        if (!username) {
          username = currentUsername;
        }

        console.log(`Starting purchase for package ${packageId}... (Username: ${username})`);

        // Show loading overlay
        const loadingOverlay = document.createElement('div');
        loadingOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10001;
        `;
        loadingOverlay.innerHTML = `
          <div style="text-align: center; color: var(--text);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚è≥</div>
            <p style="font-size: 1.25rem;">Preparing checkout...</p>
          </div>
        `;
        document.body.appendChild(loadingOverlay);

        // Close modal if open
        const modal = document.getElementById('modal');
        const wasModalOpen = modal.classList.contains('active');
        if (wasModalOpen) closeModal();

        // Create basket
        const basket = await createBasket(username);
        console.log('‚úì Basket created:', basket.ident);

        // Add package
        await addPackageToBasket(basket.ident, packageId);
        console.log('‚úì Package added');

        // Detect if mobile
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;

        // Remove loading overlay
        document.body.removeChild(loadingOverlay);

        // Launch checkout
        if (typeof Tebex !== 'undefined' && typeof Tebex.checkout !== 'undefined') {
          if (isMobile) {
            // On mobile, redirect directly to checkout page (avoids popup blockers)
            console.log('Mobile detected, using redirect mode');
            const checkoutUrl = `https://checkout.tebex.io/checkout/${basket.ident}`;
            window.location.href = checkoutUrl;
          } else {
            // On desktop, use modal
            Tebex.checkout.init({
              ident: basket.ident,
              theme: 'dark',
              colors: [
                { name: "primary", color: "#01a1a4" },
                { name: "secondary", color: "#f2b841" }
              ]
            });

            Tebex.checkout.launch();

            // Success handler
            const isGift = (forUsername && forUsername !== currentUsername);
            const handler = function (event) {
              window.removeEventListener('tebex:checkout:complete', handler);
              showSuccessModal(packageName, price, username, isSubscription, isGift);
            };
            window.addEventListener('tebex:checkout:complete', handler);
          }

        } else {
          throw new Error('Tebex.js not loaded');
        }

      } catch (error) {
        console.error('Purchase error:', error);
        // Remove loading overlay if it exists
        const loadingOverlay = document.querySelector('div[style*="z-index: 10001"]');
        if (loadingOverlay) {
          document.body.removeChild(loadingOverlay);
        }
        await customAlert(error.message, 'Failed to Start Checkout', '‚ùå');
      }
    }

    async function purchaseAsGift(packageId, packageName, price, isSubscription) {
      const recipientUsername = await customPrompt(
        'Enter the recipient\'s Minecraft username:',
        'Gift Purchase',
        'Minecraft Username',
        'üéÅ'
      );

      if (!recipientUsername || !recipientUsername.trim()) {
        return;
      }

      // Call purchase with recipient's username
      purchasePackage(packageId, packageName, price, isSubscription, recipientUsername.trim());
    }

    function showSuccessModal(packageName, price, username, isSubscription, wasGift) {
      const html = `
        <div style="text-align: center; padding: 2rem; animation: fadeInUp 0.5s ease;">
          <div style="font-size: 5rem; margin-bottom: 1rem; animation: bounceIn 0.8s ease;">${wasGift ? 'üéÅ' : 'üéâ'}</div>
          <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem;">
            ${wasGift ? 'Gift Sent Successfully!' : 'Purchase Successful!'}
          </h2>
          
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
            <p style="font-size: 1.1rem; margin-bottom: 0.5rem;"><strong>${packageName}</strong></p>
            <p style="color: var(--text-muted); margin-bottom: 0.5rem;">
              ${isSubscription ? 'Monthly Subscription' : 'One-Time'}: <strong style="color: var(--primary);">$${price.toFixed(2)}</strong>
            </p>
            <p style="color: var(--text-muted);">
              ${wasGift ? 'Recipient' : 'Player'}: <strong style="color: var(--secondary);">${username}</strong>
            </p>
          </div>
          
          <div style="background: var(--dark); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; text-align: left;">
            <h3 style="color: var(--primary); margin-bottom: 1rem; text-align: center;">‚ö° What Happens Next?</h3>
            <ul style="list-style: none; padding: 0;">
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; gap: 0.75rem;">
                <span style="color: #10b981;">‚úì</span>
                <span>Payment confirmed and processed</span>
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; gap: 0.75rem;">
                <span style="color: #10b981;">‚úì</span>
                <span>Commands sent to server</span>
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; gap: 0.75rem;">
                <span style="color: var(--primary);">‚è≥</span>
                <span>Perks will be applied within <strong>2-5 minutes</strong></span>
              </li>
              <li style="padding: 0.75rem 0; display: flex; gap: 0.75rem;">
                <span style="color: var(--secondary);">üéÆ</span>
                <span>Join <strong>${STORE_CONFIG.serverIp}</strong> to enjoy!</span>
              </li>
            </ul>
          </div>
          
          <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button onclick="closeModal()" style="flex: 1; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
              Continue Shopping
            </button>
            <button onclick="closeModal(); window.location.href='${STORE_CONFIG.discordInvite}';" style="flex: 1; padding: 1rem; background: #5865f2; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
              Join Discord
            </button>
          </div>
        </div>
        
        <style>
          @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
          }
          @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
          }
        </style>
      `;

      const modalHeader = document.getElementById('modal-header');
      const modalFooter = document.getElementById('modal-footer');
      if (modalHeader) modalHeader.style.display = 'none';
      if (modalFooter) modalFooter.style.display = 'none';

      document.getElementById('modal-body').innerHTML = html;
      document.getElementById('modal').classList.add('active');
    }

    // ========================================
    // RENDER YOUR CUSTOM CARDS
    // ========================================

    function renderRanks() {
      const grid = document.getElementById('ranks-grid');
      grid.innerHTML = STORE_CONFIG.ranks.map(rank => `
        <div class="product-card" onclick="openRankModal('${rank.name}')">
          ${rank.badge ? `<span class="product-badge ${rank.badgeClass}">${rank.badge}</span>` : ''}
          ${rank.image ? `<img src="${rank.image}" alt="${rank.name}" class="product-image">` : `<div class="product-icon">${rank.icon}</div>`}
          <h3 class="product-title">${rank.name}</h3>
          <div class="product-price">${rank.subscriptionId ? `${rank.priceDisplay} or ${rank.priceSubscriptionDisplay}` : rank.priceDisplay}</div>
          <p class="product-description">${rank.description}</p>
          <div class="view-details-text">View Full Details ‚Üí</div>
        </div>
      `).join('');
    }

    function renderCrates() {
      const grid = document.getElementById('crates-grid');
      grid.innerHTML = STORE_CONFIG.crates.map(crate => `
        <div class="product-card" onclick="openSimpleModal('${crate.name}', ${crate.packageId}, ${crate.price}, false, '${crate.image || ''}', '${crate.icon}', '${crate.modalDescription || crate.description}')">
          ${crate.badge ? `<span class="product-badge ${crate.badgeClass}">${crate.badge}</span>` : ''}
          ${crate.image ? 
            `<img src="${crate.image}" alt="${crate.name}" class="product-image">` : 
            `<div class="product-icon">${crate.icon}</div>`
          }
          <h3 class="product-title">${crate.name}</h3>
          <div class="product-price">${crate.priceDisplay}</div>
          <p class="product-description">${crate.description}</p>
          <div class="view-details-text">View Full Details ‚Üí</div>
        </div>
      `).join('');
    }

    function renderCosmetics() {
      const grid = document.getElementById('cosmetics-grid');
      grid.innerHTML = STORE_CONFIG.cosmetics.map(item => `
        <div class="product-card" onclick="openSimpleModal('${item.name}', ${item.packageId}, ${item.price}, false, '${item.image || ''}', '${item.icon}', '${item.modalDescription || item.description}')">
          ${item.badge ? `<span class="product-badge ${item.badgeClass}">${item.badge}</span>` : ''}
          ${item.image ? 
            `<img src="${item.image}" alt="${item.name}" class="product-image">` : 
            `<div class="product-icon">${item.icon}</div>`
          }
          <h3 class="product-title">${item.name}</h3>
          <div class="product-price">${item.priceDisplay}</div>
          <p class="product-description">${item.description}</p>
          <div class="view-details-text">View Full Details ‚Üí</div>
        </div>
      `).join('');
    }

    function openRankModal(rankName) {
      const rank = STORE_CONFIG.ranks.find(r => r.name === rankName);
      if (!rank) return;

      const modalHeader = document.getElementById('modal-header');
      const modalFooter = document.getElementById('modal-footer');
      if (modalHeader) modalHeader.style.display = 'block';
      if (modalFooter) modalFooter.style.display = 'block';

      document.getElementById('modal-icon').innerHTML = rank.image ?
        `<img src="${rank.image}" class="modal-image">` :
        `<div style="font-size: 4rem;">${rank.icon}</div>`;
      document.getElementById('modal-title').textContent = rank.name;
      document.getElementById('modal-price').textContent = rank.subscriptionId ?
        `${rank.priceDisplay} or ${rank.priceSubscriptionDisplay}` : rank.priceDisplay;
      document.getElementById('modal-price-subtitle').textContent =
        rank.subscriptionId ? 'One-time purchase OR monthly subscription' : 'One-time purchase';

      let bodyHtml = '';

      if (rank.inGamePerks) {
        bodyHtml += `
          <div class="perk-section">
            <h3 class="perk-section-title">In-Game Perks</h3>
            <ul class="perk-list">
              ${rank.inGamePerks.map(p => {
          // If perk is an object with image
          if (typeof p === 'object' && p.text) {
            return `
                    <li style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="perk-icon">‚úì</span>
                    <span style="line-height: 1.5; display: flex; align-items: center;">
                    ${p.image ? `<img src="${p.image}" alt="${p.text}" class="perk-image-inline" style="width: auto; height: 16px; margin-top: 4px; margin-right: 4px; border-radius: 4px; flex-shrink: 0;">` : ''} ${p.text} </span>
                    </li>
                  `;
          }
          // Simple text perk
          return `<li><span class="perk-icon">‚úì</span><span>${p}</span></li>`;
        }).join('')}
            </ul>
          </div>
        `;
      }

      if (rank.landPerks) {
        bodyHtml += `
          <div class="perk-section landPerks">
            <h3 class="perk-section-title">Land Perks</h3>
            <ul class="perk-list">
              ${rank.landPerks.map(p => {
          if (typeof p === 'object' && p.text) {
            return `
                    <li style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="perk-icon">‚úì</span>
                    <span style="line-height: 1.5; display: flex; align-items: center;">
                    ${p.image ? `<img src="${p.image}" alt="${p.text}" class="perk-image-inline" style="width: auto; height: 16px; margin-top: 4px; margin-right: 4px; border-radius: 4px; flex-shrink: 0;">` : ''} ${p.text} </span>
                    </li>
                  `;
          }
          return `<li><span class="perk-icon">‚úì</span><span>${p}</span></li>`;
        }).join('')}
            </ul>
          </div>
        `;
      }

      if (rank.discordPerks) {
        bodyHtml += `
          <div class="perk-section">
            <h3 class="perk-section-title">Discord Perks</h3>
            <ul class="perk-list">
              ${rank.discordPerks.map(p => {
          if (typeof p === 'object' && p.text) {
            return `
                    <li style="display: flex; align-items: center; gap: 0.75rem;">
                    <span class="perk-icon">‚úì</span>
                    <span style="line-height: 1.5; display: flex; align-items: center;">
                    ${p.image ? `<img src="${p.image}" alt="${p.text}" class="perk-image-inline" style="width: auto; height: 16px; margin-top: 4px; margin-right: 4px; border-radius: 4px; flex-shrink: 0;">` : ''} ${p.text} </span>
                    </li>
                  `;
          }
          return `<li><span class="perk-icon">‚úì</span><span>${p}</span></li>`;
        }).join('')}
            </ul>
          </div>
        `;
      }

      document.getElementById('modal-body').innerHTML = bodyHtml;

      let footerHtml = '';
      if (rank.subscriptionId) {
        // Dual buttons - only one-time can be gifted
        footerHtml = `
          <div class="button-group">
            <button class="buy-btn" onclick="purchasePackage(${rank.packageId}, '${rank.name.replace(/'/g, "\\'")}', ${rank.price}, false)">
              <span class="btn-label">One-Time</span>
              ${rank.priceDisplay}
            </button>
            <button class="buy-btn subscription" onclick="purchasePackage(${rank.subscriptionId}, '${rank.name.replace(/'/g, "\\'")}', ${rank.priceSubscription}, true)">
              <span class="btn-label">Subscription</span>
              ${rank.priceSubscriptionDisplay}
            </button>
          </div>
          <button class="buy-btn" style="background: var(--secondary); margin-top: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;" 
                  onclick="purchaseAsGift(${rank.packageId}, '${rank.name.replace(/'/g, "\\'")}', ${rank.price}, false)">
            <span style="font-size: 1.2rem; line-height: 1;">üéÅ</span>
            <span>Gift One-Time Purchase</span>
          </button>
        `;
      } else {
        // Single button with gift option - side by side
        footerHtml = `
          <div style="display: flex; gap: 1rem;">
            <button class="buy-btn" style="flex: 1;" onclick="purchasePackage(${rank.packageId}, '${rank.name.replace(/'/g, "\\'")}', ${rank.price}, false)">
              Purchase ${rank.priceDisplay}
            </button>
            <button class="buy-btn" style="flex: 1; background: var(--secondary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;" 
                    onclick="purchaseAsGift(${rank.packageId}, '${rank.name.replace(/'/g, "\\'")}', ${rank.price}, false)">
              <span style="font-size: 1.2rem; line-height: 1;">üéÅ</span>
              <span>Gift</span>
            </button>
          </div>
        `;
      }

      document.getElementById('modal-footer').innerHTML = footerHtml;
      document.getElementById('modal').classList.add('active');
    }

    function openSimpleModal(name, packageId, price, isSub, image = '', icon = '', description = '') {
      const modalHeader = document.getElementById('modal-header');
      const modalFooter = document.getElementById('modal-footer');
      if (modalHeader) modalHeader.style.display = 'none';
      if (modalFooter) modalFooter.style.display = 'none';

      // Build enhanced modal content with full-width separator lines
      const modalContent = `
        <div style="text-align: center;">
          <!-- Icon/Image -->
          <div style="padding: 2rem 2rem 1.5rem;">
            ${image ? 
              `<img src="${image}" alt="${name}" style="max-width: 200px; max-height: 200px; border-radius: 12px; border: 1px solid var(--border);">` : 
              `<div style="font-size: 5rem;">${icon}</div>`
            }
            <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">${name}</h2>
            <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary); margin-bottom: 1rem;">$${price.toFixed(2)}</div>
          </div>
          
          <!-- Full-width separator -->
          <div style="border-bottom: 1px solid var(--border);"></div>

          <!-- Description -->
          <div style="padding: 1.5rem 2rem;">
            
            ${description ? `<p style="color: var(--text-muted); font-size: 1.125rem; max-width: 500px; margin-left: auto; margin-right: auto;">${description}</p>` : ''}
          </div>

          <!-- Full-width separator -->
          <div style="border-bottom: 1px solid var(--border);"></div>

          <!-- Purchase Buttons -->
          <div style="padding: 1.5rem 2rem;">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
              <button class="buy-btn" style="flex: 1; min-width: 200px;" onclick="purchasePackage(${packageId}, '${name.replace(/'/g, "\\'")}', ${price}, false)">
                Purchase $${price.toFixed(2)}
              </button>
              <button class="buy-btn" style="flex: 1; min-width: 200px; background: var(--secondary); display: flex; align-items: center; justify-content: center; gap: 0.5rem;" 
                      onclick="purchaseAsGift(${packageId}, '${name.replace(/'/g, "\\'")}', ${price}, false)">
                <span style="font-size: 1.2rem; line-height: 1;">üéÅ</span>
                <span>Gift</span>
              </button>
            </div>
          </div>
        </div>
      `;

      document.getElementById('modal-body').innerHTML = modalContent;
      document.getElementById('modal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }

    function scrollToSection(id, event) {
      event.preventDefault();
      const el = document.getElementById(id);
      if (el) {
        const offset = 150;
        window.scrollTo({ top: el.offsetTop - offset, behavior: 'smooth' });
      }

      document.querySelectorAll('.category-item').forEach(item => item.classList.remove('active'));
      event.target.classList.add('active');
    }

    // ========================================
    // INITIALIZE
    // ========================================

    window.addEventListener('DOMContentLoaded', function () {
      renderUsernameDisplay();
      renderRanks();
      renderCrates();
      renderCosmetics();
    });

    document.getElementById('modal').addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });
  </script>

  <div id="footer-placeholder"></div>
  <script src="components.js"></script>
</body>

</html>