<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Double A SMP - Store</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- Tebex.js for embedded checkout -->
  <script src="https://js.tebex.io/v/1.js" defer></script>
  
  <!-- External CSS -->
  <link rel="stylesheet" href="store.css">
</head>

<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <img src="AA_Logo.png" alt="Logo" style="height: 32px;">
        <span>Double A SMP</span>
      </a>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
        <li><a href="rules.html">Rules</a></li>
        <li><a href="guides.html">Guides</a></li>
        <li><a href="changelog.html">Changelog</a></li>
        <li><a href="#" class="active">Store</a></li>
      </ul>
    </div>
  </nav>

  <!-- Hero -->
  <section class="store-hero">
    <div class="store-hero-content">
      <div class="store-badge">‚ú® Support the Server</div>
      <h1>Server Store</h1>
      <p>Unlock exclusive ranks and perks to enhance your Double A SMP experience</p>
    </div>
  </section>

  <!-- Category Navigation -->
  <nav class="category-nav">
    <ul class="category-list" id="category-nav">
      <!-- Categories will be loaded dynamically -->
    </ul>
  </nav>

  <!-- Loading State -->
  <div id="loading-state" style="text-align: center; padding: 4rem;">
    <div style="font-size: 2rem; margin-bottom: 1rem;">‚è≥</div>
    <p style="color: #94a3b8;">Loading store packages from Tebex...</p>
  </div>

  <!-- Main Content -->
  <main class="container" id="store-content" style="display: none;">
    <!-- Packages will be loaded dynamically by category -->
  </main>

  <!-- Modal for package details -->
  <div class="modal-overlay" id="modal">
    <div class="modal-content">
      <div class="modal-header">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-icon" id="modal-icon"></div>
        <h2 class="modal-title" id="modal-title"></h2>
        <div class="modal-price" id="modal-price"></div>
        <div class="modal-price-subtitle" id="modal-price-subtitle"></div>
      </div>
      <div class="modal-body" id="modal-body"></div>
      <div class="modal-footer" id="modal-footer"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <img src="AA_Logo.png" alt="Logo" style="height: 32px;">
          <span>Double A SMP</span>
        </div>
        <p class="footer-text">Support the server and unlock exclusive perks</p>
      </div>
    </div>
  </footer>

  <script>
    // ========================================
    // HEADLESS API CONFIGURATION
    // ========================================
    
    const HEADLESS_CONFIG = {
      // IMPORTANT: Replace this with YOUR Headless API Public Token
      // Get it from: https://double-a-smp-store.tebex.io/admin ‚Üí Settings ‚Üí API Keys
      publicToken: '11c2h-d83f9a87902177a4fb436058df6ce2f2a0569c30', // Example: 't66x-abc123...'
      
      // API endpoints
      apiBase: 'https://headless.tebex.io/api',
      
      // Webstore identifier for checkout
      webstoreIdentifier: 'double-a-smp-store',
      
      // Custom configuration
      categoryConfig: {
        // Map category names to custom settings
        'Ranks': {
          icon: 'üéñÔ∏è',
          description: 'Server ranks with progressive perks'
        },
        'Crates': {
          icon: 'üì¶',
          description: 'Mystery crates with random rewards'
        },
        'Cosmetics': {
          icon: '‚ú®',
          description: 'Visual effects and customization'
        }
      },
      
      // Custom package metadata (optional - add images, custom perks, etc.)
      packageCustomData: {
        // Example: Map package IDs to custom data
        // You can add two package IDs - one for one-time, one for subscription
        // Example:
        // '7235170': {
        //   image: 'images/resident-preview.png',
        //   badge: 'Starter',
        //   subscriptionPackageId: '7235171', // ID of the subscription version
        //   customPerks: ['Custom perk 1', 'Custom perk 2']
        // }
        
        // CONFIGURE YOUR PACKAGES HERE
        // Add your package IDs and their subscription counterparts
        // Format:
        // 'ONE_TIME_PACKAGE_ID': {
        //   subscriptionPackageId: 'SUBSCRIPTION_PACKAGE_ID',
        //   image: 'images/package-preview.png',
        //   badge: 'Popular',
        //   customPerks: ['Perk 1', 'Perk 2', ...]
        // }
      }
    };

    // ========================================
    // USERNAME MANAGEMENT
    // ========================================
    
    /**
     * Get stored username from localStorage
     */
    function getStoredUsername() {
      return localStorage.getItem('tebex_minecraft_username') || '';
    }
    
    /**
     * Store username in localStorage
     */
    function saveUsername(username) {
      if (username && username.trim()) {
        localStorage.setItem('tebex_minecraft_username', username.trim());
      }
    }
    
    /**
     * Get username from user (with localStorage fallback)
     */
    function getUsernameForPurchase() {
      const stored = getStoredUsername();
      
      // If we have a stored username, use it
      if (stored) {
        return stored;
      }
      
      // Otherwise, will be collected in modal
      return null;
    }
    
    // ========================================
    // HEADLESS API FUNCTIONS
    // ========================================
    
    let packagesCache = [];
    let categoriesCache = [];
    
    /**
     * Fetch all categories from Headless API
     */
    async function fetchCategories() {
      try {
        const response = await fetch(
          `${HEADLESS_CONFIG.apiBase}/accounts/${HEADLESS_CONFIG.publicToken}/categories?includePackages=1`,
          {
            headers: {
              'Accept': 'application/json'
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.data || [];
      } catch (error) {
        console.error('Error fetching categories:', error);
        throw error;
      }
    }
    
    /**
     * Create a basket for checkout
     */
    async function createBasket(username) {
      try {
        const basketData = {
          complete_url: window.location.href,
          cancel_url: window.location.href,
          complete_auto_redirect: false
        };
        
        // Add username if provided
        if (username && username.trim()) {
          basketData.username = username.trim();
        }
        
        const response = await fetch(
          `${HEADLESS_CONFIG.apiBase}/accounts/${HEADLESS_CONFIG.publicToken}/baskets`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(basketData)
          }
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.data;
      } catch (error) {
        console.error('Error creating basket:', error);
        throw error;
      }
    }
    
    /**
     * Add a package to a basket
     */
    async function addPackageToBasket(basketIdent, packageId, quantity = 1) {
      try {
        const requestBody = {
          package_id: parseInt(packageId), // Ensure it's a number, not string
          quantity: quantity
        };
        
        // If basket has username_id, include it in variable_data
        // This is required for game server packages
        const basket = await getBasket(basketIdent);
        if (basket.username_id) {
          requestBody.variable_data = {
            username_id: basket.username_id
          };
        }
        
        console.log('Adding package to basket:', requestBody);
        
        const response = await fetch(
          `${HEADLESS_CONFIG.apiBase}/baskets/${basketIdent}/packages`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
          }
        );
        
        if (!response.ok) {
          // Try to get error details from response
          let errorMessage = `HTTP ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData.message) {
              errorMessage += `: ${errorData.message}`;
            }
            if (errorData.errors) {
              errorMessage += ` - ${JSON.stringify(errorData.errors)}`;
            }
          } catch (e) {
            errorMessage += `: ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }
        
        return await response.json();
      } catch (error) {
        console.error('Error adding package to basket:', error);
        throw error;
      }
    }
    
    /**
     * Get basket details
     */
    async function getBasket(basketIdent) {
      try {
        const response = await fetch(
          `${HEADLESS_CONFIG.apiBase}/accounts/${HEADLESS_CONFIG.publicToken}/baskets/${basketIdent}`,
          {
            headers: {
              'Accept': 'application/json'
            }
          }
        );
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        return data.data;
      } catch (error) {
        console.error('Error fetching basket:', error);
        throw error;
      }
    }
    
    /**
     * Purchase a package using Headless API + Tebex.js
     */
    async function purchasePackage(packageId, packageName, packagePrice, isSubscription = false) {
      // Get username input element value (will be added to modal)
      const usernameInput = document.getElementById('purchase-username-input');
      let username = usernameInput ? usernameInput.value.trim() : '';
      
      // If no username provided, check localStorage
      if (!username) {
        username = getStoredUsername();
      }
      
      // Validate username
      if (!username) {
        alert('‚ö†Ô∏è Please enter your Minecraft username to continue.');
        if (usernameInput) usernameInput.focus();
        return;
      }
      
      // Save username for future purchases
      saveUsername(username);
      
      // Save original footer content for error recovery
      const modalFooter = document.getElementById('modal-footer');
      const originalFooter = modalFooter.innerHTML;
      
      try {
        console.log(`Starting purchase for package ${packageId}... (Username: ${username})`);
        
        // Show loading state
        modalFooter.innerHTML = `
          <div style="text-align: center; padding: 1rem;">
            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚è≥</div>
            <p style="color: var(--text-muted);">Creating checkout for ${username}...</p>
          </div>
        `;
        
        // Step 1: Create basket with username
        const basket = await createBasket(username);
        console.log('‚úì Basket created:', basket.ident);
        
        // Step 2: Add package to basket
        await addPackageToBasket(basket.ident, packageId);
        console.log('‚úì Package added to basket');
        
        // Step 3: Close modal
        closeModal();
        
        // Step 4: Launch Tebex.js checkout
        if (typeof Tebex !== 'undefined' && typeof Tebex.checkout !== 'undefined') {
          console.log('‚úì Launching Tebex.js checkout...');
          
          // Initialize checkout with your branding
          Tebex.checkout.init({
            ident: basket.ident,
            theme: 'dark',
            colors: [
              { name: "primary", color: "#01a1a4" },
              { name: "secondary", color: "#f2b841" }
            ]
          });
          
          // Launch the checkout modal
          Tebex.checkout.launch();
          
          // Listen for checkout completion (only once)
          const completionHandler = function(event) {
            console.log('‚úì Purchase completed!', event);
            window.removeEventListener('tebex:checkout:complete', completionHandler);
            
            // Show fancy success modal
            showSuccessModal(packageName, packagePrice, username, isSubscription);
          };
          
          window.addEventListener('tebex:checkout:complete', completionHandler);
          
        } else {
          throw new Error('Tebex.js is not loaded');
        }
        
      } catch (error) {
        console.error('Purchase error:', error);
        
        // Show error message
        alert(`‚ö†Ô∏è Failed to start checkout:\n\n${error.message}\n\nPlease try again or contact support if the issue persists.`);
        
        // Restore footer if modal is still open
        if (document.getElementById('modal').classList.contains('active')) {
          modalFooter.innerHTML = originalFooter;
        }
      }
    }
    
    /**
     * Show fancy success modal after purchase
     */
    function showSuccessModal(packageName, packagePrice, username, isSubscription) {
      // Create success modal HTML
      const successHtml = `
        <div style="text-align: center; padding: 2rem; animation: fadeInUp 0.5s ease;">
          <div style="font-size: 5rem; margin-bottom: 1rem; animation: bounceIn 0.8s ease;">üéâ</div>
          <h2 style="font-size: 2rem; font-weight: 700; margin-bottom: 1rem; color: var(--text);">
            Purchase Successful!
          </h2>
          
          <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;">
            <p style="color: var(--text); font-size: 1.1rem; margin-bottom: 0.5rem;">
              <strong>${packageName}</strong>
            </p>
            <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 0.5rem;">
              ${isSubscription ? 'Monthly Subscription' : 'One-Time Purchase'}: <strong style="color: var(--primary);">$${packagePrice}</strong>
            </p>
            <p style="color: var(--text-muted); font-size: 0.95rem;">
              For: <strong style="color: var(--secondary);">${username}</strong>
            </p>
          </div>
          
          <div style="background: var(--dark); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; text-align: left;">
            <h3 style="color: var(--primary); font-size: 1.2rem; margin-bottom: 1rem; text-align: center;">
              ‚ö° What Happens Next?
            </h3>
            <ul style="list-style: none; padding: 0; margin: 0;">
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem;">
                <span style="color: var(--success); font-size: 1.5rem;">‚úì</span>
                <span style="color: var(--text-muted);">Payment confirmed and processed</span>
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem;">
                <span style="color: var(--success); font-size: 1.5rem;">‚úì</span>
                <span style="color: var(--text-muted);">Commands sent to server</span>
              </li>
              <li style="padding: 0.75rem 0; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem;">
                <span style="color: var(--primary); font-size: 1.5rem;">‚è≥</span>
                <span style="color: var(--text-muted);">Perks will be applied within <strong style="color: var(--text);">2-5 minutes</strong></span>
              </li>
              <li style="padding: 0.75rem 0; display: flex; align-items: center; gap: 0.75rem;">
                <span style="color: var(--secondary); font-size: 1.5rem;">üéÆ</span>
                <span style="color: var(--text-muted);">Join <strong style="color: var(--text);">play.doubleasmp.net</strong> to enjoy!</span>
              </li>
            </ul>
          </div>
          
          <p style="color: var(--text-muted); font-size: 0.9rem; margin: 1rem 0;">
            ${isSubscription ? 'üí≥ Your subscription will auto-renew monthly. You can cancel anytime from your Tebex account.' : ''}
          </p>
          
          <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button onclick="closeModal()" style="flex: 1; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
              Continue Shopping
            </button>
            <button onclick="closeModal(); window.location.href='https://discord.com/invite/h2jQRcEYvs';" style="flex: 1; padding: 1rem; background: #5865f2; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.3s ease;">
              Join Discord
            </button>
          </div>
        </div>
        
        <style>
          @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
          }
          @keyframes bounceIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
          }
        </style>
      `;
      
      // Update modal content
      document.getElementById('modal-body').innerHTML = successHtml;
      document.getElementById('modal-header').style.display = 'none';
      document.getElementById('modal-footer').style.display = 'none';
      
      // Show modal
      document.getElementById('modal').classList.add('active');
    }
    
    // ========================================
    // UI RENDERING FUNCTIONS
    // ========================================
    
    /**
     * Render category navigation
     */
    function renderCategoryNav(categories) {
      const nav = document.getElementById('category-nav');
      
      nav.innerHTML = categories.map((cat, index) => {
        const config = HEADLESS_CONFIG.categoryConfig[cat.name] || {};
        const icon = config.icon || 'üì¶';
        
        return `
          <li>
            <a href="#${cat.slug}" class="category-item ${index === 0 ? 'active' : ''}" 
               data-category="${cat.id}">
              ${icon} ${cat.name}
            </a>
          </li>
        `;
      }).join('');
      
      // Add click handlers
      document.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          document.querySelectorAll('.category-item').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          
          const categoryId = this.getAttribute('data-category');
          scrollToCategory(categoryId);
        });
      });
    }
    
    /**
     * Render all packages by category
     */
    function renderPackages(categories) {
      const container = document.getElementById('store-content');
      
      container.innerHTML = categories.map(category => {
        const config = HEADLESS_CONFIG.categoryConfig[category.name] || {};
        const packages = category.packages || [];
        
        if (packages.length === 0) return '';
        
        return `
          <section id="category-${category.id}" class="products-section" data-category="${category.id}">
            <h2 class="section-title">${category.name}</h2>
            <p class="section-subtitle">${config.description || category.description || 'Click any item to view details'}</p>
            
            <div class="products-grid">
              ${packages.map(pkg => renderPackageCard(pkg, category)).join('')}
            </div>
          </section>
        `;
      }).join('');
      
      // Add click handlers to cards
      document.querySelectorAll('[data-package-id]').forEach(card => {
        card.addEventListener('click', function() {
          const packageId = this.getAttribute('data-package-id');
          const pkg = findPackageById(packageId);
          if (pkg) {
            openPackageModal(pkg);
          }
        });
      });
    }
    
    /**
     * Render a single package card
     */
    function renderPackageCard(pkg, category) {
      const customData = HEADLESS_CONFIG.packageCustomData[pkg.id] || {};
      const badge = customData.badge || (pkg.type === 'subscription' ? 'Subscription' : '');
      const image = customData.image || pkg.image;
      
      // Determine badge class
      let badgeClass = '';
      if (badge.toLowerCase().includes('popular')) badgeClass = 'popular';
      if (badge.toLowerCase().includes('premium') || badge.toLowerCase().includes('ultimate')) badgeClass = 'premium';
      
      return `
        <div class="product-card" data-package-id="${pkg.id}">
          ${badge ? `<span class="product-badge ${badgeClass}">${badge}</span>` : ''}
          
          ${image ? 
            `<img src="${image}" alt="${pkg.name}" class="product-image">` : 
            `<div class="product-icon">${getPackageIcon(pkg.name, category.name)}</div>`
          }
          
          <h3 class="product-title">${pkg.name}</h3>
          <div class="product-price">$${pkg.base_price.toFixed(2)}</div>
          <p class="product-price-sub">${pkg.type === 'subscription' ? 'Monthly subscription' : 'One-time purchase'}</p>
          <p class="product-description">${stripHtml(pkg.description)}</p>
          <div class="view-details-text">View Full Details ‚Üí</div>
        </div>
      `;
    }
    
    /**
     * Open package details modal
     */
    function openPackageModal(pkg) {
      const customData = HEADLESS_CONFIG.packageCustomData[pkg.id] || {};
      const image = customData.image || pkg.image;
      const subscriptionPackageId = customData.subscriptionPackageId;
      const subscriptionPackage = subscriptionPackageId ? findPackageById(subscriptionPackageId) : null;
      
      // Reset modal header visibility
      document.getElementById('modal-header').style.display = 'block';
      document.getElementById('modal-footer').style.display = 'block';
      
      // Set basic info
      document.getElementById('modal-icon').innerHTML = image ? 
        `<img src="${image}" alt="${pkg.name}" class="modal-image">` : 
        getPackageIcon(pkg.name);
      
      document.getElementById('modal-title').textContent = pkg.name;
      
      // Show both prices if subscription is available
      if (subscriptionPackage) {
        document.getElementById('modal-price').textContent = 
          `$${pkg.base_price.toFixed(2)} or $${subscriptionPackage.base_price.toFixed(2)}/mo`;
        document.getElementById('modal-price-subtitle').textContent = 
          'One-time purchase OR monthly subscription';
      } else {
        document.getElementById('modal-price').textContent = `$${pkg.base_price.toFixed(2)}`;
        document.getElementById('modal-price-subtitle').textContent = 
          pkg.type === 'subscription' ? 'Monthly recurring subscription' : 'One-time purchase';
      }
      
      // Set description
      let bodyHtml = `
        <div class="perk-section">
          <h3 class="perk-section-title">Description</h3>
          <div style="color: var(--text-muted); line-height: 1.8;">
            ${pkg.description}
          </div>
        </div>
      `;
      
      if (customData.customPerks) {
        bodyHtml += `
          <div class="perk-section">
            <h3 class="perk-section-title">What You Get</h3>
            <ul class="perk-list">
              ${customData.customPerks.map(perk => {
                if (typeof perk === 'object' && perk.text) {
                  return `
                    <li>
                      <span class="perk-icon">‚úì</span>
                      <div>
                        <span>${perk.text}</span>
                        ${perk.image ? `<img src="${perk.image}" alt="${perk.text}" class="perk-image">` : ''}
                      </div>
                    </li>
                  `;
                }
                return `<li><span class="perk-icon">‚úì</span><span>${perk}</span></li>`;
              }).join('')}
            </ul>
          </div>
        `;
      }
      
      // Add username input section
      const storedUsername = getStoredUsername();
      bodyHtml += `
        <div class="perk-section">
          <h3 class="perk-section-title">üéÆ Minecraft Username</h3>
          <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.95rem;">
            Enter your Minecraft username to receive your perks in-game:
          </p>
          <input 
            type="text" 
            id="purchase-username-input" 
            placeholder="Your Minecraft username"
            value="${storedUsername}"
            style="width: 100%; padding: 0.875rem; background: var(--dark); border: 2px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; font-family: var(--font-display); transition: border-color 0.3s ease;"
            onfocus="this.style.borderColor='var(--primary)'"
            onblur="this.style.borderColor='var(--border)'"
          />
          <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.85rem;">
            ${storedUsername ? '‚úì Username saved from last purchase' : 'Your username will be saved for future purchases'}
          </p>
        </div>
      `;
      
      document.getElementById('modal-body').innerHTML = bodyHtml;
      
      // Set footer with purchase button(s)
      let footerHtml = '';
      
      if (subscriptionPackage) {
        // Show two buttons for packages with subscription option
        footerHtml = `
          <div class="button-group">
            <button class="buy-btn" onclick="purchasePackage(${pkg.id}, '${pkg.name.replace(/'/g, "\\'")}', ${pkg.base_price}, false)">
              <span class="btn-label">One-Time</span>
              $${pkg.base_price.toFixed(2)}
            </button>
            <button class="buy-btn subscription" onclick="purchasePackage(${subscriptionPackage.id}, '${pkg.name.replace(/'/g, "\\'")}', ${subscriptionPackage.base_price}, true)">
              <span class="btn-label">Subscription</span>
              $${subscriptionPackage.base_price.toFixed(2)}/mo
            </button>
          </div>
        `;
      } else {
        // Single button
        const isSubscription = pkg.type === 'subscription';
        footerHtml = `
          <button class="buy-btn ${isSubscription ? 'subscription' : ''}" 
                  onclick="purchasePackage(${pkg.id}, '${pkg.name.replace(/'/g, "\\'")}', ${pkg.base_price}, ${isSubscription})">
            Purchase $${pkg.base_price.toFixed(2)}${isSubscription ? '/mo' : ''}
          </button>
        `;
      }
      
      document.getElementById('modal-footer').innerHTML = footerHtml;
      
      // Show modal
      document.getElementById('modal').classList.add('active');
      
      // Focus username input if empty
      setTimeout(() => {
        const input = document.getElementById('purchase-username-input');
        if (input && !input.value) {
          input.focus();
        }
      }, 100);
    }
    
    /**
     * Close modal
     */
    function closeModal() {
      document.getElementById('modal').classList.remove('active');
    }
    
    // ========================================
    // UTILITY FUNCTIONS
    // ========================================
    
    /**
     * Find package by ID
     */
    function findPackageById(packageId) {
      for (const category of categoriesCache) {
        const pkg = category.packages.find(p => p.id == packageId);
        if (pkg) return pkg;
      }
      return null;
    }
    
    /**
     * Get icon for package based on name/category
     */
    function getPackageIcon(packageName, categoryName) {
      const name = packageName.toLowerCase();
      const cat = (categoryName || '').toLowerCase();
      
      // Rank icons
      if (name.includes('resident')) return 'üå±';
      if (name.includes('merchant')) return 'üí∞';
      if (name.includes('pioneer')) return '‚öîÔ∏è';
      if (name.includes('guardian')) return 'üõ°Ô∏è';
      if (name.includes('sovereign')) return 'üëë';
      if (name.includes('overlord')) return '‚ö°';
      
      // Crate icons
      if (name.includes('common') || name.includes('basic')) return 'üì¶';
      if (name.includes('rare')) return 'üíé';
      if (name.includes('legendary') || name.includes('epic')) return '‚≠ê';
      
      // Cosmetic icons
      if (name.includes('particle')) return '‚ú®';
      if (name.includes('pet')) return 'üêæ';
      if (name.includes('color')) return 'üé®';
      
      // Default by category
      if (cat.includes('rank')) return 'üéñÔ∏è';
      if (cat.includes('crate')) return 'üì¶';
      if (cat.includes('cosmetic')) return '‚ú®';
      
      return 'üéÅ';
    }
    
    /**
     * Strip HTML tags from string
     */
    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      const text = tmp.textContent || tmp.innerText || '';
      return text.length > 120 ? text.substring(0, 120) + '...' : text;
    }
    
    /**
     * Scroll to category section
     */
    function scrollToCategory(categoryId) {
      const section = document.querySelector(`[data-category="${categoryId}"]`);
      if (section) {
        const navbarHeight = document.querySelector('.navbar').offsetHeight;
        const categoryNavHeight = document.querySelector('.category-nav').offsetHeight;
        const offset = navbarHeight + categoryNavHeight + 20;
        
        const targetPosition = section.offsetTop - offset;
        window.scrollTo({ top: targetPosition, behavior: 'smooth' });
      }
    }
    
    // ========================================
    // INITIALIZATION
    // ========================================
    
    /**
     * Initialize the store
     */
    async function initStore() {
      try {
        console.log('üîÑ Initializing Headless API store...');
        
        // Check if token is configured
        if (HEADLESS_CONFIG.publicToken === 'YOUR_HEADLESS_PUBLIC_TOKEN_HERE') {
          throw new Error('Please configure your Headless API public token in HEADLESS_CONFIG');
        }
        
        // Fetch categories and packages
        console.log('üì¶ Fetching packages from Tebex...');
        categoriesCache = await fetchCategories();
        
        console.log(`‚úì Loaded ${categoriesCache.length} categories`);
        
        // Count total packages
        const totalPackages = categoriesCache.reduce((sum, cat) => sum + (cat.packages?.length || 0), 0);
        console.log(`‚úì Loaded ${totalPackages} packages`);
        
        // Render UI
        renderCategoryNav(categoriesCache);
        renderPackages(categoriesCache);
        
        // Hide loading, show content
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('store-content').style.display = 'block';
        
        console.log('‚úÖ Store initialized successfully!');
        
      } catch (error) {
        console.error('‚ùå Failed to initialize store:', error);
        
        // Show error message
        document.getElementById('loading-state').innerHTML = `
          <div style="text-align: center; padding: 4rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ùå</div>
            <h2 style="color: var(--text); margin-bottom: 1rem;">Failed to Load Store</h2>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">${error.message}</p>
            <button onclick="location.reload()" class="buy-btn" style="display: inline-block;">
              Retry
            </button>
          </div>
        `;
      }
    }
    
    // Wait for DOM and Tebex.js to load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initStore);
    } else {
      initStore();
    }
    
    // Click outside modal to close
    document.getElementById('modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    // Smooth scroll on category click
    window.addEventListener('scroll', function() {
      const sections = document.querySelectorAll('.products-section');
      const navbarHeight = document.querySelector('.navbar').offsetHeight;
      const categoryNavHeight = document.querySelector('.category-nav').offsetHeight;
      
      sections.forEach(section => {
        const sectionTop = section.offsetTop - navbarHeight - categoryNavHeight - 100;
        const sectionBottom = sectionTop + section.offsetHeight;
        
        if (window.scrollY >= sectionTop && window.scrollY < sectionBottom) {
          const categoryId = section.getAttribute('data-category');
          document.querySelectorAll('.category-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('data-category') === categoryId) {
              item.classList.add('active');
            }
          });
        }
      });
    });
  </script>
</body>
</html>